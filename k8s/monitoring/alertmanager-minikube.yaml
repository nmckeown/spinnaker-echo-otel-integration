apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: monitoring
data:
  alertmanager.yml: |
    global:
      resolve_timeout: 5m

    route:
      receiver: dev-null
      group_by: ['alertname','job']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 1h
      routes:
        - matchers:
            - service="spinnaker"
            - severity="critical"
          receiver: gmail-spinnaker

    receivers:
      - name: dev-null

      - name: gmail-spinnaker
        email_configs:
          - to: "noelmckeown@gmail.com"
            from: "noelmckeown@gmail.com"                 # must match the Gmail account
            smarthost: "smtp.gmail.com:587"
            auth_username: "noelmckeown@gmail.com"  # read from mounted file
            auth_identity: "noelmckeown@gmail.com"
            auth_password_file: /etc/alertmanager/gmail/app_password
            require_tls: true
            send_resolved: true
            headers:
              subject: "[Spinnaker][CRIT] {{ .CommonLabels.execution_name }} failed"
            html: |
              <b>{{ .CommonLabels.alertname }}</b><br/>
              App: {{ .CommonLabels.execution_application }}<br/>
              Status: {{ .CommonLabels.execution_status }}<br/>
              Trigger: {{ .CommonLabels.execution_triggertype }}<br/>
              ID: {{ .CommonLabels.execution_id }}<br/>
              {{ .CommonAnnotations.description }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: alertmanager
  namespace: monitoring
  labels:
    app: alertmanager
spec:
  replicas: 1
  selector:
    matchLabels: { app: alertmanager }
  template:
    metadata:
      labels: { app: alertmanager }
    spec:
      containers:
        - name: alertmanager
          image: prom/alertmanager:v0.27.0
          imagePullPolicy: IfNotPresent
          args:
            - --config.file=/etc/alertmanager/alertmanager.yml
            - --storage.path=/alertmanager
          ports:
            - name: http
              containerPort: 9093
          volumeMounts:
            - name: config
              mountPath: /etc/alertmanager
            - name: data
              mountPath: /alertmanager
            - name: gmail
              mountPath: /etc/alertmanager/gmail
              readOnly: true
          resources:
            requests:
              cpu: "50m"
              memory: "64Mi"
            limits:
              cpu: "200m"
              memory: "256Mi"
      volumes:
        - name: config
          configMap:
            name: alertmanager-config
            items:
              - key: alertmanager.yml
                path: alertmanager.yml
        - name: gmail
          secret:
            secretName: alertmanager-gmail
            items:
              - key: gmail_user
                path: user
              - key: gmail_app_password
                path: app_password
        - name: data
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: alertmanager
  namespace: monitoring
  labels:
    app: alertmanager
spec:
  type: NodePort
  selector:
    app: alertmanager
  ports:
    - name: http
      port: 9093
      targetPort: 9093
      nodePort: 30093
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-rules
  namespace: monitoring
data:
  general.rules.yaml: |
    groups:
      - name: spinnaker-alerts
        rules:
        - alert: SpinnakerExecutionFailed
          # Select incomplete Spinnaker executions for fluent with TERMINAL status
          expr: spinnaker_execution_incomplete{execution_application="fluent", execution_status="TERMINAL"} == 1
          for: 1m
          labels:
            severity: critical
            service: spinnaker
          annotations:
            summary: "Pipeline FAILURE: {{ $labels.execution_name }} ({{ $labels.execution_application }})"
            description: |
              Execution {{ $labels.execution_id }} in application {{ $labels.execution_application }} has failed (status TERMINAL).
              Triggered by: {{ $labels.execution_user }}
              Trigger Type: {{ $labels.execution_triggertype }}
              Cancel Reason: {{ $labels.execution_cancelreason }}
              Started: {{ $labels.execution_starttime }}
              Ended: {{ $labels.execution_endtime }}
              Instance: {{ $labels.instance }}
      - name: test
        rules:
        - alert: GmailTest
          expr: vector(1)
          for: 1m
          labels: { severity: critical, service: spinnaker }
          annotations:
            description: "Test email from Alertmanager via Gmail"